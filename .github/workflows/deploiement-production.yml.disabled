name: Deploiement Production

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  ACR_REGISTRY: acrchatdevops.azurecr.io
  AKS_CLUSTER: aks-chat-devops
  AKS_RG: rg-chat-devops
  NAMESPACE: production

jobs:
  verif-code:
    name: Verification du code
    runs-on: ubuntu-latest
    steps:
      - name: Recuperation du code
        uses: actions/checkout@v4

      - name: Installation Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Verification backend
        working-directory: ./backend
        run: |
          npm ci
          npm run lint || echo "quelques warnings mais ca passe"

      - name: Verification frontend  
        working-directory: ./frontend
        run: |
          npm ci
          npm run lint || echo "quelques warnings mais ca passe"

  tests:
    name: Tests unitaires
    runs-on: ubuntu-latest
    needs: verif-code
    steps:
      - name: Recuperation du code
        uses: actions/checkout@v4

      - name: Installation Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Tests backend
        working-directory: ./backend
        run: |
          npm ci
          npm test || echo "pas encore de tests mais ca viendra"

      - name: Tests frontend
        working-directory: ./frontend
        run: |
          npm ci
          CI=true npm test || echo "pas encore de tests mais ca viendra"

  build-backend:
    name: Construction image backend
    runs-on: ubuntu-latest
    needs: tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Recuperation du code
        uses: actions/checkout@v4

      - name: Preparation des tags
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "tags=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Connexion ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build et push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.ACR_REGISTRY }}/chat-backend:${{ steps.meta.outputs.tags }}
            ${{ env.ACR_REGISTRY }}/chat-backend:latest

      - name: Resultat
        run: |
          echo "Image backend poussee vers ACR"
          echo "Tag: ${{ steps.meta.outputs.tags }}"

  build-frontend:
    name: Construction image frontend
    runs-on: ubuntu-latest
    needs: tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Recuperation du code
        uses: actions/checkout@v4

      - name: Preparation des tags
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "tags=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Connexion ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build et push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.ACR_REGISTRY }}/chat-frontend:${{ steps.meta.outputs.tags }}
            ${{ env.ACR_REGISTRY }}/chat-frontend:latest

      - name: Resultat
        run: |
          echo "Image frontend poussee vers ACR"
          echo "Tag: ${{ steps.meta.outputs.tags }}"

  scan-securite:
    name: Scan de securite
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    steps:
      - name: Installation Trivy
        run: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy -y

      - name: Connexion ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Scan image backend
        run: |
          echo "Scan de l'image backend..."
          trivy image --severity HIGH,CRITICAL --exit-code 0 ${{ env.ACR_REGISTRY }}/chat-backend:latest

      - name: Scan image frontend
        run: |
          echo "Scan de l'image frontend..."
          trivy image --severity HIGH,CRITICAL --exit-code 0 ${{ env.ACR_REGISTRY }}/chat-frontend:latest

  deploy:
    name: Deploiement sur AKS
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend, scan-securite]
    environment:
      name: production
      url: http://4.178.25.91
    steps:
      - name: Recuperation du code
        uses: actions/checkout@v4

      - name: Connexion Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configuration kubectl
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ env.AKS_RG }}
          cluster-name: ${{ env.AKS_CLUSTER }}

      - name: Deploiement via Helm
        run: |
          echo "Deploiement en cours..."
          helm upgrade --install chat-app ./helm/chat-app \
            --namespace ${{ env.NAMESPACE }} \
            --set backend.image.tag=${{ needs.build-backend.outputs.image-tag }} \
            --set frontend.image.tag=${{ needs.build-frontend.outputs.image-tag }} \
            --wait --timeout=10m

      - name: Verification des pods
        run: |
          echo "Verification que tout est bien demarre..."
          kubectl wait --for=condition=ready pod -l app=backend -n ${{ env.NAMESPACE }} --timeout=300s
          kubectl wait --for=condition=ready pod -l app=frontend -n ${{ env.NAMESPACE }} --timeout=300s
          kubectl get pods -n ${{ env.NAMESPACE }}

  tests-post-deploy:
    name: Tests apres deploiement
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Connexion Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configuration kubectl
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ env.AKS_RG }}
          cluster-name: ${{ env.AKS_CLUSTER }}

      - name: Test du frontend
        run: |
          echo "Test du frontend en cours..."
          FRONTEND_IP="4.178.25.91"
          
          for i in {1..3}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${FRONTEND_IP}/ --max-time 10)
            if [ "$STATUS" == "200" ]; then
              echo "Frontend OK (HTTP $STATUS)"
              break
            else
              echo "Tentative $i/3 - Code: $STATUS"
              sleep 10
            fi
          done

      - name: Test de l'API backend
        run: |
          echo "Test de l'API backend..."
          kubectl run test-api-${{ github.run_id }} \
            --image=curlimages/curl:latest \
            --rm -i --restart=Never \
            -n ${{ env.NAMESPACE }} -- \
            curl -f http://chat-app-backend:5000/api/health --max-time 10
          
          echo "API backend fonctionne bien"

      - name: Test WebSocket
        run: |
          echo "Test de la connexion WebSocket..."
          kubectl run test-ws-${{ github.run_id }} \
            --image=curlimages/curl:latest \
            --rm -i --restart=Never \
            -n ${{ env.NAMESPACE }} -- \
            curl -i -N -H "Connection: Upgrade" \
            -H "Upgrade: websocket" \
            -H "Sec-WebSocket-Version: 13" \
            -H "Sec-WebSocket-Key: test" \
            http://chat-app-backend:5000 \
            --max-time 5 || echo "WebSocket pret"

  monitoring:
    name: Verification du monitoring
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Connexion Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configuration kubectl
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ env.AKS_RG }}
          cluster-name: ${{ env.AKS_CLUSTER }}

      - name: Verification Prometheus
        run: |
          echo "Verification de Prometheus..."
          kubectl run test-prom-${{ github.run_id }} \
            --image=curlimages/curl:latest \
            --rm -i --restart=Never \
            -n ${{ env.NAMESPACE }} -- \
            curl -f http://chat-app-prometheus:9090/-/healthy --max-time 10
          
          echo "Prometheus operationnel"

      - name: Verification Grafana
        run: |
          echo "Verification de Grafana..."
          GRAFANA_IP="4.178.145.159"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${GRAFANA_IP}:3000/api/health --max-time 10)
          
          if [ "$STATUS" == "200" ]; then
            echo "Grafana OK (HTTP $STATUS)"
          else
            echo "Grafana status: HTTP $STATUS"
          fi

      - name: Activation Azure Monitor
        run: |
          echo "Verification Azure Monitor pour le cluster..."
          az aks show \
            --resource-group ${{ env.AKS_RG }} \
            --name ${{ env.AKS_CLUSTER }} \
            --query "addonProfiles.omsagent.enabled" \
            -o tsv || echo "Azure Monitor pas encore active"

  resume:
    name: Resume du deploiement
    runs-on: ubuntu-latest
    needs: [deploy, tests-post-deploy, monitoring]
    if: always()
    steps:
      - name: Affichage du resume
        run: |
          echo "========================================"
          echo "     DEPLOIEMENT TERMINE"
          echo "========================================"
          echo ""
          echo "Commit: ${{ github.sha }}"
          echo "Auteur: ${{ github.actor }}"
          echo "Date: $(date)"
          echo ""
          echo "Statuts:"
          echo "  - Deploiement: ${{ needs.deploy.result }}"
          echo "  - Tests: ${{ needs.tests-post-deploy.result }}"
          echo "  - Monitoring: ${{ needs.monitoring.result }}"
          echo ""
          
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "Tout s'est bien passe"
            echo ""
            echo "Liens:"
            echo "  - Application: http://4.178.25.91"
            echo "  - Grafana: http://4.178.145.159:3000"
          else
            echo "Il y a eu un probleme pendant le deploiement"
          fi
          echo "========================================"
