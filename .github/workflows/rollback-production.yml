name: Rollback Automatique en Production

on:
  workflow_dispatch:
    inputs:
      revision:
        description: 'Num√©ro de r√©vision Helm √† restaurer (laisser vide pour version pr√©c√©dente)'
        required: false
        type: string

env:
  AKS_CLUSTER: aks-chat-devops
  AKS_RESOURCE_GROUP: rg-chat-devops
  NAMESPACE: production

jobs:
  analyse-pre-rollback:
    name: Analyse Avant Rollback
    runs-on: ubuntu-latest
    outputs:
      current-revision: ${{ steps.info.outputs.revision }}
      backup-created: ${{ steps.backup.outputs.created }}
    steps:
      - name: Connexion √† Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configuration de kubectl
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ env.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ env.AKS_CLUSTER }}

      - name: R√©cup√©ration des informations actuelles
        id: info
        run: |
          echo "üìä √âtat actuel du d√©ploiement:"
          helm list -n production
          
          CURRENT_REV=$(helm list -n production -o json | jq -r '.[0].revision')
          echo "revision=${CURRENT_REV}" >> $GITHUB_OUTPUT
          echo "R√©vision actuelle: ${CURRENT_REV}"

      - name: Historique des d√©ploiements
        run: |
          echo "üìú Historique Helm:"
          helm history chat-app -n production --max 10

      - name: √âtat des pods avant rollback
        run: |
          echo "üîç √âtat des pods:"
          kubectl get pods -n production -o wide

      - name: Backup de la configuration
        id: backup
        run: |
          echo "üíæ Cr√©ation du backup..."
          mkdir -p /tmp/backup
          
          kubectl get all,configmap,secret -n production -o yaml > /tmp/backup/production-state-$(date +%Y%m%d-%H%M%S).yaml
          
          echo "created=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Backup cr√©√©"

  execution-rollback:
    name: Ex√©cution du Rollback
    runs-on: ubuntu-latest
    needs: analyse-pre-rollback
    environment:
      name: production-rollback
      url: http://4.178.25.91
    steps:
      - name: Connexion √† Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configuration de kubectl
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ env.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ env.AKS_CLUSTER }}

      - name: Rollback Helm
        run: |
          if [ -n "${{ inputs.revision }}" ]; then
            echo "üîÑ Rollback vers la r√©vision ${{ inputs.revision }}..."
            helm rollback chat-app ${{ inputs.revision }} -n production --wait --timeout=10m
          else
            echo "üîÑ Rollback vers la r√©vision pr√©c√©dente..."
            helm rollback chat-app -n production --wait --timeout=10m
          fi

      - name: V√©rification post-rollback
        run: |
          echo "‚è≥ Attente de la stabilisation des pods..."
          sleep 30
          
          kubectl wait --for=condition=ready pod -l app=backend -n production --timeout=300s
          kubectl wait --for=condition=ready pod -l app=frontend -n production --timeout=300s
          
          echo "‚úÖ Tous les pods sont pr√™ts"

      - name: Tests de sant√©
        run: |
          echo "üè• V√©rification de la sant√© des services..."
          
          # Test du backend
          kubectl run rollback-health-test-${{ github.run_id }} \
            --image=curlimages/curl:latest \
            --rm -i --restart=Never \
            -n production -- \
            curl -f http://chat-app-backend:5000/api/health --max-time 10
          
          echo "‚úÖ Backend op√©rationnel apr√®s rollback"

      - name: V√©rification du frontend
        run: |
          FRONTEND_IP="4.178.25.91"
          
          echo "üåê Test du frontend..."
          for i in {1..5}; do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://${FRONTEND_IP}/ --max-time 10)
            if [ "$RESPONSE" == "200" ]; then
              echo "‚úÖ Frontend accessible (tentative $i/5)"
              break
            else
              echo "‚è≥ Tentative $i/5 - Code: $RESPONSE"
              sleep 10
            fi
          done

  verification-post-rollback:
    name: V√©rifications Apr√®s Rollback
    runs-on: ubuntu-latest
    needs: execution-rollback
    steps:
      - name: Connexion √† Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configuration de kubectl
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ env.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ env.AKS_CLUSTER }}

      - name: √âtat final des pods
        run: |
          echo "üìä √âtat des pods apr√®s rollback:"
          kubectl get pods -n production -o wide

      - name: Logs r√©cents
        run: |
          echo "üìã Logs backend (derni√®res lignes):"
          kubectl logs -n production -l app=backend --tail=20
          
          echo ""
          echo "üìã Logs frontend (derni√®res lignes):"
          kubectl logs -n production -l app=frontend --tail=20

      - name: √âv√©nements r√©cents
        run: |
          echo "üì∞ √âv√©nements Kubernetes r√©cents:"
          kubectl get events -n production --sort-by='.lastTimestamp' | tail -15

      - name: R√©vision finale
        run: |
          echo "üìå R√©vision Helm apr√®s rollback:"
          helm list -n production
          
          NEW_REV=$(helm list -n production -o json | jq -r '.[0].revision')
          echo "Nouvelle r√©vision: ${NEW_REV}"
          echo "Ancienne r√©vision: ${{ needs.analyse-pre-rollback.outputs.current-revision }}"

  rapport-rollback:
    name: Rapport de Rollback
    runs-on: ubuntu-latest
    needs: [analyse-pre-rollback, execution-rollback, verification-post-rollback]
    if: always()
    steps:
      - name: G√©n√©ration du rapport
        run: |
          echo "========================================"
          echo "       RAPPORT DE ROLLBACK             "
          echo "========================================"
          echo ""
          echo "üìÖ Date: $(date)"
          echo "üîÑ Run ID: ${{ github.run_id }}"
          echo "üë§ D√©clench√© par: ${{ github.actor }}"
          echo ""
          echo "üìä R√©visions:"
          echo "  - Avant rollback: ${{ needs.analyse-pre-rollback.outputs.current-revision }}"
          if [ -n "${{ inputs.revision }}" ]; then
            echo "  - Cible du rollback: ${{ inputs.revision }}"
          else
            echo "  - Cible du rollback: R√©vision pr√©c√©dente"
          fi
          echo ""
          echo "Statuts des op√©rations:"
          echo "  - Analyse pr√©-rollback: ${{ needs.analyse-pre-rollback.result }}"
          echo "  - Ex√©cution rollback: ${{ needs.execution-rollback.result }}"
          echo "  - V√©rifications post-rollback: ${{ needs.verification-post-rollback.result }}"
          echo ""
          
          if [ "${{ needs.execution-rollback.result }}" == "success" ] && \
             [ "${{ needs.verification-post-rollback.result }}" == "success" ]; then
            echo "‚úÖ ROLLBACK R√âUSSI"
            echo ""
            echo "L'application a √©t√© restaur√©e √† une version pr√©c√©dente stable."
            echo ""
            echo "üîó Liens:"
            echo "  - Application: http://4.178.25.91"
            echo "  - Grafana: http://4.178.145.159:3000"
          else
            echo "‚ùå ROLLBACK √âCHOU√â"
            echo ""
            echo "‚ö†Ô∏è ATTENTION: Le rollback a rencontr√© des probl√®mes."
            echo "Action imm√©diate requise!"
          fi
          echo "========================================"

      - name: Notification d'√©chec
        if: needs.execution-rollback.result != 'success'
        run: |
          echo "üö® ALERTE CRITIQUE: Le rollback a √©chou√©"
          echo "V√©rification manuelle requise imm√©diatement"
          exit 1
