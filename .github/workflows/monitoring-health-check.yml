name: Surveillance Continue et Health Checks

on:
  schedule:
    # Une fois par jour √† 9h00 UTC (10h00 CET)
    - cron: '0 9 * * *'
  workflow_dispatch:

env:
  AKS_CLUSTER: aks-chat-devops
  AKS_RESOURCE_GROUP: rg-chat-devops
  NAMESPACE: production

jobs:
  verification-sante:
    name: V√©rification de la Sant√© des Services
    runs-on: ubuntu-latest
    steps:
      - name: Test du frontend
        run: |
          echo "üåê Test du frontend..."
          FRONTEND_IP="4.178.25.91"
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://${FRONTEND_IP}/ --max-time 10)
          
          if [ "$RESPONSE" == "200" ]; then
            echo "‚úÖ Frontend accessible (HTTP $RESPONSE)"
          else
            echo "‚ùå Frontend inaccessible (HTTP $RESPONSE)"
            exit 1
          fi

      - name: Test de Grafana
        run: |
          echo "ÔøΩ Test de Grafana..."
          GRAFANA_IP="4.178.145.159"
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://${GRAFANA_IP}:3000/api/health --max-time 10)
          
          if [ "$RESPONSE" == "200" ]; then
            echo "‚úÖ Grafana accessible (HTTP $RESPONSE)"
          else
            echo "‚ö†Ô∏è Grafana potentiellement inaccessible (HTTP $RESPONSE)"
          fi


  rapport-monitoring:
    name: G√©n√©ration du Rapport de Monitoring
    runs-on: ubuntu-latest
    needs: [verification-sante]
    if: always()
    steps:
      - name: R√©sum√© de la surveillance
        run: |
          echo "========================================"
          echo "     RAPPORT DE SURVEILLANCE           "
          echo "========================================"
          echo ""
          echo "üìÖ Date: $(date)"
          echo "üîÑ Run ID: ${{ github.run_id }}"
          echo ""
          echo "Statuts des jobs:"
          echo "  - Sant√© des services: ${{ needs.verification-sante.result }}"
          echo ""
          
          if [ "${{ needs.verification-sante.result }}" == "success" ]; then
            echo "‚úÖ TOUS LES SERVICES PUBLICS SONT OP√âRATIONNELS"
            echo ""
            echo "üîó Liens rapides:"
            echo "  - Application: http://4.178.25.91"
            echo "  - Grafana: http://4.178.145.159:3000"
          else
            echo "‚ö†Ô∏è ATTENTION: Certains services ont des probl√®mes"
            echo "Consultez les logs ci-dessus pour plus de d√©tails"
          fi
          echo "========================================"

      - name: Alerte en cas d'√©chec
        if: needs.verification-sante.result != 'success'
        run: |
          echo "üö® ALERTE: Probl√®me d√©tect√© avec les services"
          echo "Action requise: V√©rifier l'application"
          exit 1

