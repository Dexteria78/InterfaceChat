name: Surveillance Continue et Health Checks

on:
  schedule:
    # Toutes les 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:

env:
  AKS_CLUSTER: aks-chat-devops
  AKS_RESOURCE_GROUP: rg-chat-devops
  NAMESPACE: production

jobs:
  verification-sante:
    name: V√©rification de la Sant√© des Services
    runs-on: ubuntu-latest
    steps:
      - name: Connexion √† Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configuration de kubectl
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ env.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ env.AKS_CLUSTER }}

      - name: V√©rification des pods
        id: check-pods
        run: |
          echo "üìä √âtat des pods en production:"
          kubectl get pods -n production
          
          # Compte des pods non-ready
          NOT_READY=$(kubectl get pods -n production --no-headers | grep -v "Running\|Completed" | wc -l)
          echo "pods-not-ready=${NOT_READY}" >> $GITHUB_OUTPUT
          
          if [ $NOT_READY -gt 0 ]; then
            echo "‚ö†Ô∏è WARNING: ${NOT_READY} pod(s) ne sont pas en √©tat Running"
            kubectl describe pods -n production | grep -A 10 "Events:"
          fi

      - name: Test du frontend
        run: |
          echo "üåê Test du frontend..."
          FRONTEND_IP="4.178.25.91"
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://${FRONTEND_IP}/ --max-time 10)
          
          if [ "$RESPONSE" == "200" ]; then
            echo "‚úÖ Frontend accessible (HTTP $RESPONSE)"
          else
            echo "‚ùå Frontend inaccessible (HTTP $RESPONSE)"
            exit 1
          fi

      - name: Test de l'API backend
        run: |
          echo "üîß Test de l'API backend..."
          
          # Test depuis un pod temporaire
          kubectl run health-test-${{ github.run_id }} \
            --image=curlimages/curl:latest \
            --rm -i --restart=Never \
            -n production -- \
            curl -f http://chat-app-backend:5000/api/health --max-time 10
          
          echo "‚úÖ API backend r√©pond correctement"

      - name: V√©rification du WebSocket
        run: |
          echo "üîå V√©rification du WebSocket..."
          
          # Test de connexion WebSocket
          FRONTEND_IP="4.178.25.91"
          
          kubectl run ws-test-${{ github.run_id }} \
            --image=curlimages/curl:latest \
            --rm -i --restart=Never \
            -n production -- \
            curl -i -N -H "Connection: Upgrade" \
            -H "Upgrade: websocket" \
            -H "Sec-WebSocket-Version: 13" \
            -H "Sec-WebSocket-Key: test" \
            http://chat-app-backend:5000 \
            --max-time 5 || echo "WebSocket test termin√©"

      - name: V√©rification d'Ollama
        run: |
          echo "ü§ñ V√©rification d'Ollama..."
          
          kubectl run ollama-test-${{ github.run_id }} \
            --image=curlimages/curl:latest \
            --rm -i --restart=Never \
            -n production -- \
            curl -f http://chat-app-ollama:11434/api/tags --max-time 10
          
          echo "‚úÖ Ollama r√©pond correctement"

      - name: V√©rification de Prometheus
        run: |
          echo "üìä V√©rification de Prometheus..."
          
          kubectl run prometheus-test-${{ github.run_id }} \
            --image=curlimages/curl:latest \
            --rm -i --restart=Never \
            -n production -- \
            curl -f http://chat-app-prometheus:9090/-/healthy --max-time 10
          
          echo "‚úÖ Prometheus op√©rationnel"

      - name: V√©rification de Grafana
        run: |
          echo "üìà V√©rification de Grafana..."
          GRAFANA_IP="4.178.145.159"
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://${GRAFANA_IP}:3000/api/health --max-time 10)
          
          if [ "$RESPONSE" == "200" ]; then
            echo "‚úÖ Grafana accessible (HTTP $RESPONSE)"
          else
            echo "‚ö†Ô∏è Grafana potentiellement inaccessible (HTTP $RESPONSE)"
          fi

  metriques-ressources:
    name: Collecte des M√©triques de Ressources
    runs-on: ubuntu-latest
    needs: verification-sante
    steps:
      - name: Connexion √† Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configuration de kubectl
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ env.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ env.AKS_CLUSTER }}

      - name: M√©triques des pods
        run: |
          echo "üìä Utilisation des ressources par pod:"
          kubectl top pods -n production || echo "Metrics server non disponible"

      - name: M√©triques des nodes
        run: |
          echo "üñ•Ô∏è Utilisation des ressources par node:"
          kubectl top nodes || echo "Metrics server non disponible"

      - name: Statistiques Azure AKS
        run: |
          echo "‚òÅÔ∏è M√©triques Azure AKS:"
          
          # CPU du cluster
          az monitor metrics list \
            --resource "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ env.AKS_RESOURCE_GROUP }}/providers/Microsoft.ContainerService/managedClusters/${{ env.AKS_CLUSTER }}" \
            --metric "node_cpu_usage_percentage" \
            --interval PT1M \
            --output table || echo "M√©triques non disponibles"

      - name: Espace disque des PVC
        run: |
          echo "üíæ V√©rification de l'espace disque:"
          kubectl get pvc -n production
          
          # Pour chaque PVC, v√©rifier l'utilisation
          for pvc in $(kubectl get pvc -n production -o jsonpath='{.items[*].metadata.name}'); do
            echo "PVC: $pvc"
            kubectl get pvc $pvc -n production -o jsonpath='{.status.capacity.storage}'
            echo ""
          done

  verification-logs:
    name: Analyse des Logs et Erreurs
    runs-on: ubuntu-latest
    needs: verification-sante
    steps:
      - name: Connexion √† Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configuration de kubectl
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ env.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ env.AKS_CLUSTER }}

      - name: Logs du backend (derni√®res erreurs)
        run: |
          echo "üîç Recherche d'erreurs dans les logs backend:"
          kubectl logs -n production -l app=backend --tail=100 | grep -i "error\|exception\|fatal" || echo "Aucune erreur d√©tect√©e"

      - name: Logs du frontend (derni√®res erreurs)
        run: |
          echo "üîç Recherche d'erreurs dans les logs frontend:"
          kubectl logs -n production -l app=frontend --tail=100 | grep -i "error\|exception" || echo "Aucune erreur d√©tect√©e"

      - name: √âv√©nements Kubernetes r√©cents
        run: |
          echo "üìã √âv√©nements Kubernetes r√©cents:"
          kubectl get events -n production --sort-by='.lastTimestamp' | tail -20

      - name: V√©rification des red√©marrages
        run: |
          echo "üîÑ Pods avec red√©marrages:"
          kubectl get pods -n production -o json | jq -r '.items[] | select(.status.containerStatuses[]?.restartCount > 0) | "\(.metadata.name): \(.status.containerStatuses[].restartCount) restarts"' || echo "Aucun red√©marrage d√©tect√©"

  rapport-monitoring:
    name: G√©n√©ration du Rapport de Monitoring
    runs-on: ubuntu-latest
    needs: [verification-sante, metriques-ressources, verification-logs]
    if: always()
    steps:
      - name: R√©sum√© de la surveillance
        run: |
          echo "========================================"
          echo "     RAPPORT DE SURVEILLANCE           "
          echo "========================================"
          echo ""
          echo "üìÖ Date: $(date)"
          echo "üîÑ Run ID: ${{ github.run_id }}"
          echo ""
          echo "Statuts des jobs:"
          echo "  - Sant√© des services: ${{ needs.verification-sante.result }}"
          echo "  - M√©triques ressources: ${{ needs.metriques-ressources.result }}"
          echo "  - Analyse des logs: ${{ needs.verification-logs.result }}"
          echo ""
          
          if [ "${{ needs.verification-sante.result }}" == "success" ] && \
             [ "${{ needs.metriques-ressources.result }}" == "success" ] && \
             [ "${{ needs.verification-logs.result }}" == "success" ]; then
            echo "‚úÖ TOUS LES SERVICES SONT OP√âRATIONNELS"
            echo ""
            echo "üîó Liens rapides:"
            echo "  - Application: http://4.178.25.91"
            echo "  - Grafana: http://4.178.145.159:3000"
            echo "  - Prometheus: http://<node-ip>:32269"
          else
            echo "‚ö†Ô∏è ATTENTION: Certains services ont des probl√®mes"
            echo "Consultez les logs ci-dessus pour plus de d√©tails"
          fi
          echo "========================================"

      - name: Alerte en cas d'√©chec
        if: needs.verification-sante.result != 'success'
        run: |
          echo "üö® ALERTE: Probl√®me d√©tect√© avec les services"
          echo "Action requise: V√©rifier les pods et les logs"
          exit 1
